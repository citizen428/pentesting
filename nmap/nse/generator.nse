description = [[
Displays the contents of the "generator" meta tag if there is one.
]]

author = "Michael Kohl"
license = "Same as Nmap--See http://nmap.org/book/man-legal.html"
categories = {"discovery", "safe"}

---
-- @output
-- PORT    STATE SERVICE
-- 21/tcp  open  ftp
-- 22/tcp  open  ssh
-- 25/tcp  open  smtp
-- 80/tcp  open  http
-- |_generator: TYPO3 4.2 CMS
-- 111/tcp open  rpcbind
-- 199/tcp open  smux
-- 443/tcp open  https
-- |_generator: TYPO3 4.2 CMS
-- 587/tcp open  submission

require('http')
require('shortport')

portrule = shortport.http

action = function(host, port)
   local response, loc, generator

   response = http.get(host, port, '/')

   -- deal with redirects
   while response['status-line']:lower():match("^http/1.1 30[12]") do
      loc = response.header['location']
      response = http.get_url(loc)
   end

   for line in response.body:gmatch("[^\r\n]+") do
      generator = line:match('<meta name="generator" content="(.*)" />')
      if generator then
         return generator
      end
   end
end
